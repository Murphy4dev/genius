include ./config.mk
OUTPUT_DIR := ../output
IMAGE := $(OUTPUT_DIR)/genius.elf

# The directory that contains the /source and /demo sub directories.
ROOT = ./..
INCLUDE_DIRS += -I$(ROOT)/include \
				-I$(ROOT)/include/CMSIS \
				-I$(ROOT)/include/utils
				
CC = arm-none-eabi-gcc
LD = arm-none-eabi-gcc
SIZE = arm-none-eabi-size
MAKE = make

CFLAGS += -ffreestanding -mthumb -mcpu=cortex-m3
CFLAGS += -Wall -Wextra -Wshadow -Wno-unused-value
CFLAGS += -g3 -Os -ffunction-sections -fdata-sections
CFLAGS += -MMD -MP -MF"$(@:%.o=%.d)" -MT $@
#CFLAGS += -std=c99
#CFLAGS += -Wpedantic -fanalyzer
#CFLAGS += -flto
CFLAGS += $(INCLUDE_DIRS)

LDFLAGS = -T ./genius.ld
LDFLAGS += -Xlinker -Map=$(OUTPUT_DIR)/genius.map
LDFLAGS += -Xlinker --gc-sections
LDFLAGS += -nostartfiles
LDFLAGS += -specs=nano.specs -specs=nosys.specs # -specs=rdimon.specs

#
# Kernel build.
#
KERNEL_DIR = $(ROOT)/kernel/source
INCLUDE_DIRS += -I$(KERNEL_DIR)/include \
				-I$(KERNEL_DIR)/portable/GCC/ARM_CM3
VPATH += $(KERNEL_DIR) $(KERNEL_DIR)/portable/MemMang $(KERNEL_DIR)/portable/GCC/ARM_CM3
SOURCE_FILES += $(KERNEL_DIR)/tasks.c
SOURCE_FILES += $(KERNEL_DIR)/list.c
SOURCE_FILES += $(KERNEL_DIR)/queue.c
SOURCE_FILES += $(KERNEL_DIR)/timers.c
SOURCE_FILES += $(KERNEL_DIR)/event_groups.c
SOURCE_FILES += $(KERNEL_DIR)/stream_buffer.c
SOURCE_FILES += $(KERNEL_DIR)/portable/MemMang/heap_4.c
SOURCE_FILES += $(KERNEL_DIR)/portable/GCC/ARM_CM3/port.c

#
# Setup build.
#
SETUP_DIR = $(ROOT)/kernel/setup
VPATH += $(SETUP_DIR)
SOURCE_FILES += $(SETUP_DIR)/startup_gcc.c
SOURCE_FILES += $(SETUP_DIR)/printf-stdarg.c
SOURCE_FILES += $(SETUP_DIR)/RegTest.c

# Percepio TraceRecorder (FreeRTOS-Plus-Trace)
TRACERECORDER_DIR = $(ROOT)/kernel/trace
TRACERECORDER_CFG_DIR = $(ROOT)/include/TraceRecorderConfig
VPATH += $(TRACERECORDER_DIR)
VPATH += $(TRACERECORDER_DIR)/kernelports/FreeRTOS
VPATH += $(TRACERECORDER_DIR)/streamports/RingBuffer
INCLUDE_DIRS += -I$(TRACERECORDER_CFG_DIR)
INCLUDE_DIRS += -I$(TRACERECORDER_DIR)/include 
INCLUDE_DIRS += -I$(TRACERECORDER_DIR)/kernelports/FreeRTOS/include
INCLUDE_DIRS += -I$(TRACERECORDER_DIR)/streamports/RingBuffer/include
SOURCE_FILES +=	(TRACERECORDER_DIR)/kernelports/FreeRTOS/trcKernelPort.c
SOURCE_FILES +=	(TRACERECORDER_DIR)/streamports/RingBuffer/trcStreamPort.c
SOURCE_FILES += (TRACERECORDER_DIR)/trcAssert.c
SOURCE_FILES +=	(TRACERECORDER_DIR)/trcCounter.c
SOURCE_FILES +=	(TRACERECORDER_DIR)/trcDependency.c
SOURCE_FILES +=	(TRACERECORDER_DIR)/trcDiagnostics.c
SOURCE_FILES +=	(TRACERECORDER_DIR)/trcEntryTable.c
SOURCE_FILES +=	(TRACERECORDER_DIR)/trcError.c
SOURCE_FILES +=	(TRACERECORDER_DIR)/trcEvent.c
SOURCE_FILES +=	(TRACERECORDER_DIR)/trcEventBuffer.c
SOURCE_FILES +=	(TRACERECORDER_DIR)/trcExtension.c
SOURCE_FILES +=	(TRACERECORDER_DIR)/trcHardwarePort.c
SOURCE_FILES +=	(TRACERECORDER_DIR)/trcHeap.c
SOURCE_FILES +=	(TRACERECORDER_DIR)/trcInternalEventBuffer.c
SOURCE_FILES +=	(TRACERECORDER_DIR)/trcInterval.c
SOURCE_FILES +=	(TRACERECORDER_DIR)/trcISR.c
SOURCE_FILES +=	(TRACERECORDER_DIR)/trcMultiCoreEventBuffer.c
SOURCE_FILES +=	(TRACERECORDER_DIR)/trcObject.c
SOURCE_FILES +=	(TRACERECORDER_DIR)/trcPrint.c
SOURCE_FILES +=	(TRACERECORDER_DIR)/trcRunnable.c
SOURCE_FILES +=	(TRACERECORDER_DIR)/trcSnapshotRecorder.c
SOURCE_FILES +=	(TRACERECORDER_DIR)/trcStackMonitor.c
SOURCE_FILES +=	(TRACERECORDER_DIR)/trcStateMachine.c
SOURCE_FILES +=	(TRACERECORDER_DIR)/trcStaticBuffer.c
SOURCE_FILES +=	(TRACERECORDER_DIR)/trcStreamingRecorder.c
SOURCE_FILES +=	(TRACERECORDER_DIR)/trcString.c
SOURCE_FILES +=	(TRACERECORDER_DIR)/trcTask.c
SOURCE_FILES +=	(TRACERECORDER_DIR)/trcTimestamp.c

#
# utils entry point.
#
UTILS_DIR = $(ROOT)/utils
VPATH += $(UTILS_DIR)
SOURCE_FILES += (UTILS_DIR)/hook.c
SOURCE_FILES += (UTILS_DIR)/uart.c

#
# Application entry point.  main_blinky is self contained.  main_full builds
# the above common demo (and test) files too.
#
APP_DIR = $(ROOT)/nanoapps
VPATH += $(APP_DIR) 

ifeq ($(config_hello_world),yes)
VPATH += $(APP_DIR)/hello_world
SOURCE_FILES += (APP_DIR)/hello_world/main.c
endif

#Create a list of object files with the desired output directory path.
OBJS = $(SOURCE_FILES:%.c=%.o)
OBJS_NO_PATH = $(notdir $(OBJS))
OBJS_OUTPUT = $(OBJS_NO_PATH:%.o=$(OUTPUT_DIR)/%.o)

#Create a list of dependency files with the desired output directory path.
DEP_FILES := $(SOURCE_FILES:%.c=$(OUTPUT_DIR)/%.d)
DEP_FILES_NO_PATH = $(notdir $(DEP_FILES))
DEP_OUTPUT = $(DEP_FILES_NO_PATH:%.d=$(OUTPUT_DIR)/%.d)

all: $(IMAGE)

%.o : %.c
$(OUTPUT_DIR)/%.o : %.c $(OUTPUT_DIR)/%.d Makefile
	$(CC) $(CFLAGS) -c $< -o $@

$(IMAGE): ./genius.ld $(OBJS_OUTPUT) Makefile
	@echo ""
	@echo ""
	@echo "--- Final linking ---"
	@echo ""
	$(LD) $(CFLAGS) $(LDFLAGS) $(OBJS_OUTPUT) -o $(IMAGE)
	$(SIZE) $(IMAGE)

$(DEP_OUTPUT):
include $(wildcard $(DEP_OUTPUT))

clean:
	rm -f $(IMAGE) $(OUTPUT_DIR)/RTOSDemo.map $(OUTPUT_DIR)/*.o $(OUTPUT_DIR)/*.d

#use "make print-[VARIABLE_NAME] to print the value of a variable generated by
#this makefile.
print-%  : ; @echo $* = $($*)

.PHONY: all clean


